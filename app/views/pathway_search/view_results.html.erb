<% provide(:title, 'Pathway Results') %>
<div class="banner" style="margin-top: -30px;padding-top:40px;">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>Pathway Search</h1>
      </div>
    </div>
  </div>
</div>
<div id="white-strip-pathway">
  <div class="container">
    <div class="col-md-12 col-md-offset-1">
      <div class="row">
        <div class="col-md-4 step">
          <div class="numberCircle">1</div> My Details
        </div>
        <div class="col-md-4 step">
          <div class="numberCircle">2</div> Choose Interests &amp; Careers
        </div>
        <div class="col-md-4 step current">
          <div class="numberCircle current-circle">3</div> Results and selection
        </div>
      </div>
    </div>
  </div>
</div>
<div id="page" style="padding-top:30px;">
  <div class="container">
    <div class="col-md-10 login-card col-md-offset-1">
      <div id = "log"></div>
      <div class="col-md-12">
        <%  @course_obj.year_structures.each do |y| %> 
          <button id=<%= "btn_year_#{y.read_attribute_before_type_cast('year_of_study')}" %> class="btn btn-lg btn-block" type="button">
            <%= y.year_of_study_before_type_cast.to_i.ordinalize %> Year
          </button>
          <div id=<%= "div_year_#{y.read_attribute_before_type_cast('year_of_study')}" %>>
            <% y.groups.each do |grp| %>
              <% if grp.compulsory %>
                <% grp.uni_modules.each do |y_req_module| %>
                  <%= " - #{y_req_module[:name]} (#{y_req_module[:credits]} credits)" %> <br/>
                <% end %>
              <% end %>
            <% end %>
            <% y.groups.each do |grp| %>
              <% if !grp.compulsory %>
                <br/>
                <%= "Select #{grp.total_credits} credits from #{grp.uni_modules.size} modules" %>
                <br/>
                <% grp.uni_modules.each do |y_opt_module| %>
                  <%= " - #{y_opt_module[:name]} (#{y_opt_module[:credits]} credits)" %> <br/>
                <% end %>
              <% end %>
            <% end %>
          </div>
          <div class="modal fade" id="selectionModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Select a Module:</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          <%  end %>
          <button id="btn_all_years" class="btn btn-lg btn-block" type="button">show all</button>
        </div>

        <div class="row">
          <h3><%= @year_of_study.to_i.ordinalize %> Year</h3>
          <!--groups-->
          <% @groups.each do |group| %>       
          <div class="col-md-5 login-card">
            <h3><%= group.name %></h3>
            <% @displayed = [] %>
            <% @group_selection = [] %>
            <!--choices as buttons, once a button is clicked next show a column for the remaining choices in the group or the group shows-->
            <% @results.each do |result| %>
            <% if UniModule.all_modules_in_group(group).include?(result.first) %>
            <% @displayed << result.first %>
            <% tagsmatched = result.second %>
            <div class="row login-card res-card result-card-<%= colour_code_card_group tagsmatched, @chosen_tags %> res-btn" id="<%= result.first.id %>">
              <div class="col-md-4" style="width: 75%">
                <p> <%= result.first.name %> </p>
              </div>
              <div class="col-md-1 tag-match-figure" style="font-size:18px;">
               <%= percentage_tag tagsmatched.length, @chosen_tags.length %>
             </div>
             <div class="col-md-1" style="font-size: 18px; float: right">
              <%= link_to '<i class="fa fa-info-circle" aria-hidden="true"></i>'.html_safe, result.first, method: :get %>
            </div>
          </div>
          <% else %>
          <% end %>
          <% end %>
          <% UniModule.all_modules_in_group(group).each do |mod| %>
          <% if !@displayed.include?(mod) %>
          <% uni_mod = @results.select{ |uni_module, tagsmatched| uni_module.id == mod.id}.first %>
          <% if uni_mod.present? %>
          <% @displayed << uni_mod %>
          <% tagsmatched = uni_mod.second %>
          <div class="row login-card res-card result-card-<%= colour_code_card_group tagsmatched, @chosen_tags %> res-btn" id="<%= mod.id %>">
            <div class="col-md-4" style="width: 75%">
              <p> <%= mod.name %> </p>
            </div>
            <div class="col-md-1 tag-match-figure" style="font-size:18px;">
             <%= percentage_tag tagsmatched.length, @chosen_tags.length %>
           </div>
           <div class="col-md-1" style="font-size: 18px; float: right">
            <%= link_to '<i class="fa fa-info-circle" aria-hidden="true"></i>'.html_safe, uni_mod.first, method: :get %>
          </div>
        </div>
        <% else %>
        <div class="row login-card res-card result-card-orange res-btn" id="<%= mod.id %>">
          <div class="col-md-4" style="width: 75%">
            <p> <%= mod.name %> </p>
          </div>
          <div class="col-md-1 tag-match-figure" style="font-size:18px;">
            <p> 0&#37; </p>
          </div>
          <div class="col-md-1" style="font-size: 18px; float: right">
            <%= link_to '<i class="fa fa-info-circle" aria-hidden="true"></i>'.html_safe, (UniModule.find(mod)), method: :get %>
          </div>
        </div>
        <% end %>
        <% else %>
        <% end %>
        <% end %>
      </div>
      <% end %>
    </div>
    <div class="row" style="margin-top: 60px">
      <% if logged_in? %>
      <form>
        <div class="col-md-4">
          <button type="submit" class="btn btn-lg save-button" id="save"><span><i class="fa fa-star" aria-hidden="true"></i>  Save Pathway</span>
          </button>
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="save=name" placeholder="Name your Pathway" required>
        </div>
      </form>
      <script>
        $(window).load(function() {
          $("#save").click(function() {
            /* get html path */
          })
        })
      </script>
      <% else %>
      <form action="/login" method="get">
        <button type="submit" class="btn btn-lg btn-disabled save-button" data-toggle="tooltip" data-placement="right" title="To save modules, you must be logged in." id="save"><span><i class="fa fa-star-o" aria-hidden="true"></i>  Save Pathway</span>
        </button>
      </form>
      <% end %>
    </div>

    <div class="form-group" style="margin-top: 30px">
      <%= link_to "< Back to previous page", "#", method: :get %>
    </div>
  </div>
</div>
</div>
</div>

<script type="text/javascript">
  function colour_code_card_group(module_matches, search_tags) {
    if((module_matches.length / search_tags.length) > 0.6) {
      return "green"
    } else {
      return "orange"
    }
  }


  function create_module_card(module) {
    var result = <%= raw @results.to_json%>.filter(function(mod) {
      if(mod[0].id == module.id){
        return mod;
      }
    });

    if(result.length > 0) {
      var tagsmatched = result[0][1]
      return "<div class=\"row login-card res-card result-card-" + colour_code_card_group(tagsmatched, <%= raw @chosen_tags %>) +  " res-btn\" id=\"" + module.id + "\">" +
        "<div class=\"col-md-8\">" +
          "<p>" +  module.code + "</p>" +
          "<p>" +  module.name + "</p>" +
        "</div>" +
        "<div class=\"col-md-1\" style=\"font-size: 18px; float: right; padding-top: 15px\">" +
          "<a href=\"/uni_modules/" + module.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>" +
        "</div>" +
        "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px;\">" +
          "<h4>" + Math.round((tagsmatched.length / <%= raw @chosen_tags %>.length) * 100) + " %</h4>"
        "</div>" +
      "</div>"
    } else {
      return "<div class=\"row login-card res-card result-card-orange res-btn\" id=\"" + module.id + "\">" +
        "<div class=\"col-md-8\">" +
          "<p>" +  module.code + "</p>" +
          "<p>" + module.name + "</p>" +
        "</div>" +
         "<div class=\"col-md-1\" style=\"font-size: 18px; float: right; padding-top: 15px\">" +
          "<a href=\"/uni_modules/" + module.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>" +
        "</div>" +
         "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px;\">" +
          "<h4> 0% </h4>"
        "</div>" +
      "</div>"
    }
  }

  function doLog(logObj, message){
    logObj.innerHTML += message;
  }

  function showYear(divs, year, logObj){
    for(i=0; i<divs.length; i++){
      if(i!=year) $(divs[i]).slideUp();
    }
    $(divs[year]).slideDown();
  }

  function updateUI(tableArea){

    var blank_cell = "<button type=\"button\" class=\"row login-card res-card res-btn\">" +
        "<div class=\"col-md-12\" style=\"font-size: 18px; align: center\">" +
          "<p> + Pick a Module </p>" +
        "</div>" +
      "</button>"
    var data = '<%=raw @course_obj.to_json(
      include:
        {year_structures:
          {include:
            {groups:
              {:include => :uni_modules}}}}).sub("'", "\\\\'") %>';
    //data = data.replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0');
    var js_course = jQuery.parseJSON(data);

    for(year=1; year<=js_course.year_structures.length; year++){
      var targetDiv = document.getElementById("div_year_" + (year)); //div_year_i
      targetDiv.innerHTML = "Requied modules in year " + year + "<br/>";
      var required_group = js_course.year_structures[year-1].groups[0].uni_modules;
      var modules_year_long = [];
      var modules_first_semester = [];
      var modules_second_semester = [];
      var modules_any_semester = [];
      for(module=0; module<required_group.length; module++){
        if(required_group[module].semester == 3){
          modules_year_long.push(required_group[module]);
        }else if(required_group[module].semester == 2){
          modules_second_semester.push(required_group[module]);
        }else if(required_group[module].semester == 1){
          modules_first_semester.push(required_group[module]);
        }else{
          modules_any_semester.push(required_group[module]);
        }
        targetDiv.innerHTML += required_group[module].name + " (" + required_group[module].credits + " credits)<br/>";
      }
      targetDiv.innerHTML += "1st semester: " + modules_first_semester.length + "<br/>";
      targetDiv.innerHTML += "2nd semester: " + modules_second_semester.length + "<br/>";
      targetDiv.innerHTML += "Year long: " + modules_year_long.length + "<br/>";
      targetDiv.innerHTML += "Any semester: " + modules_any_semester.length + "<br/>";
      var myTable =
      "<table id =\"results_table_" + year + "\">"+
        "<tr>"+
          "<th><div class=\"col-md-12 login-card\">" +
                  "<h3>Semester 1</h3>" + 
          "</th>"+
          "<th><div class=\"col-md-12 login-card\">" +
                  "<h3>Semester 2</h3>" +
          "</th>"+
        "</tr>";
      var s1 = 0;
      var s2 = 0;
      for(i=0; i<modules_year_long.length; i++){
        myTable +=
        "<tr>"+
          "<td colspan=2>" + create_module_card(modules_year_long[i]) + "</td>"+
        "</tr>";
        s1++;
        s2++;
      }
      for(i=s1; i<4; i++){
        myTable +=
        "<tr>"+
          "<td>" + blank_cell + "</td>"+
          "<td>" + blank_cell + "</td>"+
        "</tr>";
      }
      myTable += "</table>";
      targetDiv.innerHTML += myTable;



      var myTableOnPage = document.getElementById('results_table_'+year);
      //myTableOnPage.rows[0].cells[1].innerHTML = 'Hello';
      for(i=0; i<modules_first_semester.length; i++){
        myTableOnPage.rows[s1+1].cells[0].innerHTML = create_module_card(modules_first_semester[i])
        s1++;
      }
      for(i=0; i<modules_second_semester.length; i++){
        myTableOnPage.rows[s2+1].cells[1].innerHTML = create_module_card(modules_second_semester[i])
        s2++;
      }
      for(i=0; i<modules_any_semester.length; i++){
        if(s2<s1){
          myTableOnPage.rows[s2+1].cells[1].innerHTML =  create_module_card(modules_any_semester[i])
          s2++;
        }else{
          myTableOnPage.rows[s1+1].cells[0].innerHTML =  create_module_card(modules_any_semester[i])
          s1++;
        }
      }

    }
  }


  $(document).ready(function(){

    var total_years = 0;
    var btns = [];
    var divs = [];
    for(i=1; i<10; i++){
      var btn = document.getElementById("btn_year_"+i);
      var div = document.getElementById("div_year_"+i);
      if(!btn) break;
      else{
        $(div).hide();
        total_years = i;
        divs.push(div);
        btns.push(btn);
      }

    }
    for(var i=0; i<btns.length; i++){
      (function(_i){
        $(btns[_i]).click(function () {
          showYear(divs, _i, log);
        });
      })(i);
    }
    $("#btn_all_years").click(function () {
      for(i=0; i<divs.length; i++){
        $(divs[i]).slideDown();
      }
    });

    var tableArea = document.getElementById('div_year_1');
    updateUI(tableArea);

    document.getElementById('btn_year_<%=@year_of_study%>').click();

  });
</script>



