<% provide(:title, 'Pathway Results') %>
<div class="banner" style="margin-top: -30px;padding-top:40px;">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>Pathway Search</h1>
      </div>
    </div>
  </div>
</div>
<div id="white-strip-pathway">
  <div class="container">
    <div class="col-md-12 col-md-offset-1">
      <div class="row">
        <div class="col-md-4 step">
          <div class="numberCircle">1</div> My Details
        </div>
        <div class="col-md-4 step">
          <div class="numberCircle">2</div> Choose Interests &amp; Careers
        </div>
        <div class="col-md-4 step current">
          <div class="numberCircle current-circle">3</div> Results and selection
        </div>
      </div>
    </div>
  </div>
</div>
<div id="page" style="padding-top:30px;">
  <div class="container">
    <div class="col-md-10 login-card col-md-offset-1">
      <div id = "log"></div>
      <div class="col-md-12">
        <%  @course_obj.year_structures.each do |y| %> 
          <button id=<%= "btn_year_#{y.read_attribute_before_type_cast('year_of_study')}" %> class="btn btn-lg btn-block" type="button">
            <%= y.year_of_study_before_type_cast.to_i.ordinalize %> Year
          </button>
          <div id=<%= "div_year_#{y.read_attribute_before_type_cast('year_of_study')}" %>>
            <% @displayed = [] %>
            <% @completed_groups = [] %>
            <% y.groups.each do |grp| %>
              <% if grp.compulsory %>
                <% grp.uni_modules.each do |y_req_module| %>
                <% @displayed << y_req_module %>
                  <%= " - #{y_req_module[:name]} (#{y_req_module[:credits]} credits)" %> <br/>
                <% end %>
                <% @completed_groups << grp %>
              <% end %>
            <% end %>
            <% y.groups.each do |grp| %>
              <% if !grp.compulsory %>
                <br/>
                <%= "Select #{grp.total_credits} credits from #{grp.uni_modules.size} modules" %>
                <br/>
                <% grp.uni_modules.each do |y_opt_module| %>
                  <%= " - #{y_opt_module[:name]} (#{y_opt_module[:credits]} credits)" %> <br/>
                <% end %>
              <% end %>
            <% end %>
          </div>
          <div class="modal fade" id="optionsModalYear<%= y.year_of_study_before_type_cast.to_i %>" tabindex="-1" role="dialog" aria-hidden="true" style="margin-top: 50px">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                  <h2 class="modal-title" id="exampleModalLabel">Select a Module:</h2>
                </div>
                <div class="modal-body">
                  <% @current_options = [] %>
                  <% y.groups.each do |grp| %>
                    <% if !@completed_groups.include? grp %>
                      <% @remaining_credits = grp.total_credits %>
                      <% grp.uni_modules.each do |mod| %>
                        <% if !@displayed.include? mod %>
                          <% temp_credits = @remaining_credits %>
                          <% if (temp_credits -= mod.credits) >= 0 %>
                            <% @current_options << mod %>
                          <% end %>
                        <% else %>
                          <% @remaining_credits -= mod.credits %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>

                  <% @displayed = [] %>
                  <% @i = 0 %>
                  <% @results.each do |result| %>
                    <% if @current_options.include? (result.first) %>
                      <% @displayed << result.first %>
                      <% tagsmatched = result.second %>
                      <div class ="row">
                        <button type="button" class="login-card res-card result-card-<%= colour_code_card_group tagsmatched, @chosen_tags %> res-btn" id="optButton<%= @i %>" onClick="send_click(this.id)">
                          <div class="col-md-4" style="width: 75%">
                            <p> <%= result.first.name %> </p>
                          </div>
                          <div class="col-md-1 tag-match-figure" style="font-size:18px;">
                           <%= percentage_tag tagsmatched.length, @chosen_tags.length %>
                          </div>
                          <div class="col-md-1" style="font-size: 18px; float: right">
                            <%= link_to '<i class="fa fa-info-circle" aria-hidden="true"></i>'.html_safe, result.first, method: :get %>
                          </div>
                        </button>
                      </div>
                    <% end %>
                    <% @i +=1 %>
                  <% end %>
                  <% @current_options.each do |opt| %>
                    <% if !@displayed.include? opt %>
                      <% @displayed << opt %>
                      <div class="row">
                        <button type="button" class="login-card res-card result-card-orange res-btn" id="optButton<%= @i %>" onClick="send_click(this.id)">
                          <div class="col-md-4" style="width: 75%">
                            <p> <%= opt.name %> </p>
                          </div>
                          <div class="col-md-1 tag-match-figure" style="font-size:18px;">
                            <p> 0&#37; </p>
                          </div>
                          <div class="col-md-1" style="font-size: 18px; float: right">
                            <%= link_to '<i class="fa fa-info-circle" aria-hidden="true"></i>'.html_safe, (UniModule.find(opt)), method: :get %>
                          </div>
                        </button>
                      </div>
                    <% end %>
                    <% @i += 1%>
                  <% end %>
                  <% if @displayed.empty? %>
                    <h2> Sorry. No Modules can be selected for this slot </h2>
                  <% end %>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        <%  end %>
        <button id="btn_all_years" class="btn btn-lg btn-block" type="button">show all</button>
      </div>
      <div class="row" style="margin-top: 60px">
        <% if logged_in? %>
        <form>
          <div class="col-md-4">
            <button type="submit" class="btn btn-lg save-button" id="save"><span><i class="fa fa-star" aria-hidden="true"></i>  Save Pathway</span>
            </button>
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" id="save=name" placeholder="Name your Pathway" required>
          </div>
        </form>
        <script>
          $(window).load(function() {
            $("#save").click(function() {
              /* get html path */
            })
          })
        </script>
        <% else %>
        <form action="/login" method="get">
          <button type="submit" class="btn btn-lg btn-disabled save-button" data-toggle="tooltip" data-placement="right" title="To save modules, you must be logged in." id="save"><span><i class="fa fa-star-o" aria-hidden="true"></i>  Save Pathway</span>
          </button>
        </form>
        <% end %>
      </div>
      <div class="form-group" style="margin-top: 30px">
        <%= link_to "< Back to previous page", "#", method: :get %>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  function colour_code_card_group(module_matches, search_tags) {
    if((module_matches.length / search_tags.length) > 0.6) {
      return "green"
    } else {
      return "orange"
    }
  }


  function create_module_card(module) {
    var result = <%= raw @results.to_json%>.filter(function(mod) {
      if(mod[0].id == module.id){
        return mod;
      }
    });

    if(result.length > 0) {
      var tagsmatched = result[0][1]
      return "<div class=\"row login-card res-card result-card-" + colour_code_card_group(tagsmatched, <%= raw @chosen_tags %>) +  " res-btn\" id=\"" + module.id + "\">" +
        "<div class=\"col-md-8\">" +
          "<p>" +  module.code + "</p>" +
          "<p>" +  module.name + "</p>" +
        "</div>" +
        "<div class=\"col-md-1\" style=\"font-size: 18px; float: right; padding-top: 15px\">" +
          "<a href=\"/uni_modules/" + module.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>" +
        "</div>" +
        "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px;\">" +
          "<h4>" + Math.round((tagsmatched.length / <%= raw @chosen_tags %>.length) * 100) + " %</h4>"
        "</div>" +
      "</div>"
    } else {
      return "<div class=\"row login-card res-card result-card-orange res-btn\" id=\"" + module.id + "\">" +
        "<div class=\"col-md-8\">" +
          "<p>" +  module.code + "</p>" +
          "<p>" + module.name + "</p>" +
        "</div>" +
         "<div class=\"col-md-1\" style=\"font-size: 18px; float: right; padding-top: 15px\">" +
          "<a href=\"/uni_modules/" + module.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>" +
        "</div>" +
         "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px;\">" +
          "<h4> 0% </h4>"
        "</div>" +
      "</div>"
    }
  }

  function doLog(logObj, message){
    logObj.innerHTML += message;
  }

  function showYear(divs, year, logObj){
    for(i=0; i<divs.length; i++){
      if(i!=year) $(divs[i]).slideUp();
    }
    $(divs[year]).slideDown();
  }

  function create_blank_cell(year, index) {
    return "<button type=\"button\" id=\"button" + year + index +  "\" class=\"row login-card res-card res-btn\" data-toggle=\"modal\" data-target=\"#optionsModalYear" + year + "\" onClick=\"reply_click(this.id)\" \">" +
        "<div class=\"col-md-12\" style=\"font-size: 18px; align: center\">" +
          "<p> + Pick a Module </p>" +
        "</div>" +
      "</button>"
  }

  function reply_click(clicked_id) {
    lastClickedId = clicked_id;
    console.log("update");
    console.log("click: " + clicked_id);
  }

  function send_click(clicker_id) {
    lastClickerId = clicker_id;
    console.log("update");
    console.log("clicker: " + clicker_id);
  }

  function updateUI(tableArea){
    var data = '<%=raw @course_obj.to_json(
      include:
        {year_structures:
          {include:
            {groups:
              {:include => :uni_modules}}}}).sub("'", "\\\\'") %>';
    //data = data.replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0');
    var js_course = jQuery.parseJSON(data);

    for(year=1; year<=js_course.year_structures.length; year++){
      var targetDiv = document.getElementById("div_year_" + (year)); //div_year_i
      targetDiv.innerHTML = "Requied modules in year " + year + "<br/>";
      var required_modules = [];
      for(group = 0; group < js_course.year_structures[year-1].groups.length; ++group) {
        if(js_course.year_structures[year-1].groups[group].compulsory) {
          required_modules.push.apply(required_modules, js_course.year_structures[year-1].groups[group].uni_modules);
        }
      }
      var modules_year_long = [];
      var modules_first_semester = [];
      var modules_second_semester = [];
      var modules_any_semester = [];
      for(module=0; module<required_modules.length; module++){
        if(required_modules[module].semester == 3){
          modules_year_long.push(required_modules[module]);
        }else if(required_modules[module].semester == 2){
          modules_second_semester.push(required_modules[module]);
        }else if(required_modules[module].semester == 1){
          modules_first_semester.push(required_modules[module]);
        }else{
          modules_any_semester.push(required_modules[module]);
        }
        targetDiv.innerHTML += required_modules[module].name + " (" + required_modules[module].credits + " credits)<br/>";
      }
      targetDiv.innerHTML += "1st semester: " + modules_first_semester.length + "<br/>";
      targetDiv.innerHTML += "2nd semester: " + modules_second_semester.length + "<br/>";
      targetDiv.innerHTML += "Year long: " + modules_year_long.length + "<br/>";
      targetDiv.innerHTML += "Any semester: " + modules_any_semester.length + "<br/>";
      var myTable =
      "<table id =\"results_table_" + year + "\">"+
        "<tr>"+
          "<th><div class=\"col-md-12 login-card\">" +
                  "<h3>Semester 1</h3>" + 
          "</th>"+
          "<th><div class=\"col-md-12 login-card\">" +
                  "<h3>Semester 2</h3>" +
          "</th>"+
        "</tr>";
      var s1 = 0;
      var s2 = 0;
      for(i=0; i<modules_year_long.length; i++){
        myTable +=
        "<tr>"+
          "<td colspan=2>" + create_module_card(modules_year_long[i]) + "</td>"+
        "</tr>";
        s1++;
        s2++;
      }
      for(i=s1; i<4; i++){
        myTable +=
        "<tr>"+
          "<td>" + create_blank_cell(year, i) + "</td>"+
          "<td>" + create_blank_cell(year, i)   + "</td>"+
        "</tr>";
      }
      myTable += "</table>";
      targetDiv.innerHTML += myTable;



      var myTableOnPage = document.getElementById('results_table_'+year);
      //myTableOnPage.rows[0].cells[1].innerHTML = 'Hello';
      for(i=0; i<modules_first_semester.length; i++){
        myTableOnPage.rows[s1+1].cells[0].innerHTML = create_module_card(modules_first_semester[i])
        s1++;
      }
      for(i=0; i<modules_second_semester.length; i++){
        myTableOnPage.rows[s2+1].cells[1].innerHTML = create_module_card(modules_second_semester[i])
        s2++;
      }
      for(i=0; i<modules_any_semester.length; i++){
        if(s2<s1){
          myTableOnPage.rows[s2+1].cells[1].innerHTML =  create_module_card(modules_any_semester[i])
          s2++;
        }else{
          myTableOnPage.rows[s1+1].cells[0].innerHTML =  create_module_card(modules_any_semester[i])
          s1++;
        }
      }

    }
  }
  var lastClickedId;
  var lastClickerId;


  $(document).ready(function(){

    var total_years = 0;
    var btns = [];
    var divs = [];
    for(i=1; i<10; i++){
      var btn = document.getElementById("btn_year_"+i);
      var div = document.getElementById("div_year_"+i);
      if(!btn) break;
      else{
        $(div).hide();
        total_years = i;
        divs.push(div);
        btns.push(btn);
      }

    }
    for(var i=0; i<btns.length; i++){
      (function(_i){
        $(btns[_i]).click(function () {
          showYear(divs, _i, log);
        });
      })(i);
    }
    $("#btn_all_years").click(function () {
      for(i=0; i<divs.length; i++){
        $(divs[i]).slideDown();
      }
    });

    var tableArea = document.getElementById('div_year_1');
    updateUI(tableArea);

    document.getElementById('btn_year_<%=@year_of_study%>').click();

  });

  for(j = 0; j < <%= @i %>; ++j) {
    $(document).delegate("#optButton" + j, 'click', function(e) {
      console.log(lastClickedId);
        e.preventDefault();
        var content = $(this).html();
        $('#' + lastClickedId).replaceWith($('#' + lastClickerId));
        console.log("here2");
      });
  }
</script>



