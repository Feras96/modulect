<% provide(:title, 'Pathway Results') %>
<div class="banner" style="padding-top:40px;">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>Pathway Search</h1>
      </div>
    </div>
  </div>
</div>
<div id="white-strip-pathway">
  <div class="container">
    <div class="col-md-12 col-md-offset-1">
      <div class="row">
        <div class="col-md-4 step">
          <div class="numberCircle">1</div> My Details
        </div>
        <div class="col-md-4 step">
          <div class="numberCircle">2</div> Choose Interests &amp; Careers
        </div>
        <div class="col-md-4 step current">
          <div class="numberCircle current-circle">3</div> Results and selection
        </div>
      </div>
    </div>
  </div>
</div>
<div id="page" style="padding-top:30px;">
  <div class="container">
    <div class="col-md-10 login-card col-md-offset-1">
      <div id = "log"></div>
      <div class="col-md-12">
        <div class="row">
          <h1> Time to start picking your modules </h1>
          <h4> We've added compulsory modules for you. Just click pick a module and go through the different groups of modules available. </h4>
          <h5> Don't forget that we've given you a tag match percentage to show you how much a module matches your interests and aspirations. </h5>
        </div>
        <div class="row">
        <%  @course_obj.year_structures.each do |y| %> 
          <button id=<%= "btn_year_#{y.read_attribute_before_type_cast('year_of_study')}" %> class="btn btn-lg btn-block" type="button" style="margin-top: 5px">
            <%= y.year_of_study_before_type_cast.to_i.ordinalize %> Year&nbsp;&nbsp;<i class="fa fa-angle-down" aria-hidden="true"></i>
          </button>
          <div id=<%= "div_year_#{y.read_attribute_before_type_cast('year_of_study')}" %> style="margin-top: 20px">
          </div>
          <div class="modal fade" id="optionsModalYear<%= y.year_of_study_before_type_cast.to_i %>" tabindex="-1" role="dialog" aria-hidden="true" style="margin-top: 50px">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                  <h2 class="modal-title" id="exampleModalLabel">Select a Module:</h2>
                </div>
                <div class="modal-body" id="optionsModalBodyYear<%= y.year_of_study_before_type_cast.to_i %>">
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        <button id="btn_all_years" class="btn btn-lg btn-block" type="button" style="margin-top: 5px">show all</button>
        </div>
        <div class="row" <% if logged_in? %>style="margin-left:-30px;"<% end %>>
          <% if logged_in? %>
          <form onsubmit="savePathway();return false;" style="margin-top: 30px">
            <div class="col-md-3">
              <button type="submit" class="btn btn-lg" id="save"><span><i class="fa fa-star-o" aria-hidden="true"></i>&nbsp;&nbsp;Save Pathway</span>
              </button>
            </div>
            <div class="col-md-4">
              <input type="text" class="form-control" id="save-name" placeholder="Name your Pathway" required>
            </div>
          </form>
          <% else %>
          <form action="/login" method="get" style="margin-top:30px;">
            <button type="submit" class="btn btn-lg btn-disabled save-button" data-toggle="tooltip" data-placement="right" title="To save modules, you must be logged in."><span><i class="fa fa-star-o" aria-hidden="true"></i>&nbsp;&nbsp;Save Pathway</span>
            </button>
          </form>
          <% end %>
        </div>
        <div class="row nomobile" style="margin-top:-20px;margin-bottom:10px;">
          <div class="col-md-10 col-md-offset-1 text-right">
            <ul class="results-page-options">
              <li><a id="print" href="javascript:void()"><i class="fa fa-print" aria-hidden="true"></i>&nbsp;&nbsp;Print page</a></li>
              <li><a id="mailto" href="mailto:?subject=Modulect | Please check my modules&body=Hello {Insert name},%0A%0AI used KCL Modulect to view which optional modules I should take in order to reach my career goals. Please take a look at this link:%0A%0A
                <%= request.original_url.gsub("&", "%26") %>
                %0A%0A
                Regards,%0A
                {Insert name}" target="_blank"><i class="fa fa-envelope" aria-hidden="true"></i>&nbsp;&nbsp;Email someone</a> </li>
            </ul>
          </div>
        </div>
      <div class="form-group" style="margin-top: 30px">
        <a href="javascript:void()" onclick="javascript:history.back()" >< Back to previous page</a>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

  // get JSON object from rails
  var data = '<%=raw @course_obj.to_json(
    include:
      {year_structures:
        {include:
          {groups:
            {include:
              {:uni_modules => :uni_module_requirements}}}}).sub("'", "\\\\'") %>';
  var js_course = jQuery.parseJSON(data);

  // globals to keep track of selected modules
  //var selected_modules_per_year = <%= @selected %>;
  var required_modules_per_year = [];
  var optional_modules_per_year = [];
  var selected_ids = <%= @selected %>;

  var btns = [];
  var divs = [];
  for(i=1; i<10; i++){
    var btn = document.getElementById("btn_year_"+i);
    var div = document.getElementById("div_year_"+i);
    if(!btn) break;
    else{
      $(div).hide();
      total_years = i;
      divs.push(div);
      btns.push(btn);
    }

  }
  for(var i=0; i<btns.length; i++){
    (function(_i){
      $(btns[_i]).click(function () {
        showYear(divs, _i);
      });
    })(i);
  }
  $("#btn_all_years").click(function () {
    for(i=0; i<divs.length; i++){
      $(divs[i]).slideDown();
    }
  });

  $("#mailto").click(function() {
    document.getElementById("mailto").setAttribute("href", "mailto:?subject=Modulect | Please check my modules&body=Hello {Insert name},%0A%0AI used KCL Modulect to view which optional modules I should take in order to reach my career goals. Please take a look at this link:%0A%0A" +
      "<%= request.original_url.gsub("&", "%26") %>" + "%26selected=" + JSON.stringify(selected_modules_per_year) +
      "%0A%0A" +
      "Regards,%0A" +
      "{Insert name}");
  });

  $("#print").click(function(e) {
    for(i=0; i<divs.length; i++){
      $(divs[i]).slideDown(0);
    }
    window.print();
  });

  function courseworkCompare(a, b) {
    if(a.coursework_percentage < b.coursework_percentage) {
      return -1;
    }
    if(a.coursework_percentage > b.coursework_percentage) {
      return 1;
    }
    return 0;
  }

  function examCompare(a, b) {
    if(a.exam_percentage < b.exam_percentage) {
      return -1;
    }
    if(a.exam_percentage > b.exam_percentage) {
      return 1;
    }
    return 0;
  }

  function passRateCompare(a, b) {
    if(a.pass_rate < b.pass_rate) {
      return -1;
    }
    if(a.pass_rate > b.pass_rate) {
      return 1;
    }
    return 0;
  }


  function sort(year, group) {
    var select = document.getElementById("sort_by");
    var selected = select.options[select.selectedIndex].value;

    if(selected == "tags") {
      module_results = <%= raw @results.to_json%>;
      return optional_button_pressed(year, group, true, "tags");
    }
    else if(selected == "coursework") {
      optional_modules_per_year[year][group].uni_modules.sort(courseworkCompare);
      return optional_button_pressed(year, group, false, "coursework");
    }
    else if(selected == "exam") {
      optional_modules_per_year[year][group].uni_modules.sort(examCompare);
      return optional_button_pressed(year, group, false, "exam");
    }
    else if(selected == "pass") {
      optional_modules_per_year[year][group].uni_modules.sort(passRateCompare);
      return optional_button_pressed(year, group, false, "pass");
    }

  }

  function savePathway() {
    console.log("SAVING");
    $.ajax({
        type: "POST",
        url: "<%= application_save_pathway_path %>",
        data: {
            name: document.getElementById('save-name').value,
            data: JSON.stringify(selected_modules_per_year),
            year: <%= @year_of_study.to_i %>,
            course: <%= @course.to_i %>
        }
    })
    document.getElementById("save").innerHTML= "<span><i class=\"fa fa-star\" aria-hidden=\"true\"></i>&nbsp;&nbsp;Saved</span>";     
  }

  module_results = <%= raw @results.to_json%>;
  updateData();  
  //Initialise selected data
  for(year = 0; year < selected_modules_per_year.length; ++year) {
    selected_ids[year] = [];
    for(group = 0; group < selected_modules_per_year[year].length; ++group) {
        selected_ids[year][group] = [];
      for(module = 0; module < selected_modules_per_year[year][group].length; ++module) {
        if(selected_modules_per_year[year][group][module]) {
          var id = optional_modules_per_year[year][group].uni_modules[module].id;
          selected_ids[year][group].push(id);
        }
      }
    }
  }
  updateUI();


  // debugging
  // logStatus();
  function logStatus(){
    console.log("JSON course object");
    console.log(js_course);
    console.log("Required modules per year");
    console.log(required_modules_per_year);
    console.log("Optional modules per year");
    console.log(optional_modules_per_year);
    console.log("Selected modules per year");
    console.log(selected_modules_per_year);
  }

  // show and hide year div
  function showYear(divs, year){
    for(i=0; i<divs.length; i++){
      if(i!=year) $(divs[i]).slideUp();
    }
    $(divs[year]).slideDown();
  }

  function colour_code_card_group(module_matches, search_tags) {
    if((module_matches.length / search_tags.length) > <%= app_settings.tag_percentage_match %>) {
      return "green"
    } else {
      return "orange"
    }
  }


  function create_module_card(module, isOptional, year, group, gName, modIndex) {
    var result = module_results.filter(function(mod) {
      if(mod[0].id == module.id){
        return mod;
      }
    });
    if(!isOptional) {
      var moduleCard = "<div class=\"row login-card res-card result-card-blue res-btn\" id=\"" + module.id + "\" data-toggle=\"tooltip\" data-placement=\"right\" data-original-title=\"This is a compulsory module.\">" +
        "<div class=\"col-md-8\" >" +
          "<p>" + module.code + "</p>" +
          "<p>" + module.name + "</p>" +
        "</div>" +
         "<div class=\"col-md-1\" style=\"font-size: 18px; float: right; padding-top: 15px\">" +
            "<a href=\"/uni_modules/" + module.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>" +
          "</div>" +
         "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px; padding-left: 0px\">" +
          "<h4> Compulsory </h4>" +
        "</div>" +
      "</div>"
      return moduleCard;
    }

    if(result.length > 0) {
      var tagsmatched = result[0][1];
      var moduleCard =  "<div class=\"row login-card res-card result-card-" + colour_code_card_group(tagsmatched, <%= raw @chosen_tags %>) +  " res-btn\" id=\"" + module.id + "\" data-toggle=\"tooltip\" data-placement=\"right\" data-original-title=\"Tags Matched: " + tagsmatched.join(", ") + "\">" +
        "<div class=\"col-md-8\">" +
          "<p>" +  module.code + "</p>" +
          "<p>" + module.name + "</p>" +
        "</div>" +
        "<div class=\"col-md-1\" style=\"font-size: 18px; float: right; padding-top: 15px\">" +
          "<a href=\"/uni_modules/" + module.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>";
           if(isOptional) {
            moduleCard += "<a class=\"deselect\" onclick = \"deselectModule(" + year + ", " + group + ", " + modIndex + ")\"><i class=\"fa fa-trash\" aria-hidden=\"true\"></i></a>";
          }
          moduleCard += "</div>" +
        "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px; padding-left: 0px\">" +
          "<h4>" + Math.round((tagsmatched.length / <%= raw @chosen_tags %>.length) * 100) + " %</h4>" +
        "</div>" +
      "</div>"
      return moduleCard;
    } else {
      var moduleCard = "<div class=\"row login-card res-card result-card-orange res-btn\" id=\"" + module.id + "\" data-toggle=\"tooltip\" data-placement=\"right\" data-original-title=\"No tags matched.\">" +
        "<div class=\"col-md-8\">" +
          "<p>" +  module.code + "</p>" +
          "<p>" + module.name + "</p>" +
        "</div>" +
         "<div class=\"col-md-1\" style=\"font-size: 18px; float: right; padding-top: 15px\">" +
          "<a href=\"/uni_modules/" + module.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>";
          if(isOptional) {
            moduleCard += "<a class=\"deselect\" onclick = \"deselectModule(" + year + ", " + group + ", " + modIndex + ")\"><i class=\"fa fa-trash\" aria-hidden=\"true\"></i></a>";
          }
          moduleCard += "</div>" +
         "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px; padding-left: 0px\">" +
          "<h4> 0% </h4>" +
        "</div>" +
      "</div>"
      return moduleCard;
    }
  }

  function create_blank_cell(year) {
    return "<button type=\"button\" class=\"row login-card res-card res-btn\" data-toggle=\"modal\" data-target=\"#optionsModalYear" + year + "\">" +
        "<div class=\"col-md-12\" style=\"font-size: 18px; text-align: center\">" +
          "<p> + Pick a Module </p>" +
        "</div>" +
      "</button>"
  }


  function updateUI(){
    for(year = 0; year < js_course.year_structures.length; year++) {
      // Go through all the modules which have been selected and categories them by their semester
      selected_modules_any_semester = [];
      selected_modules_first_semester = [];
      selected_modules_second_semester = [];
      selected_modules_year_long = [];
      for(group = 0; group < optional_modules_per_year[year].length; ++group) {
        for(index = 0; index < selected_ids[year][group].length; ++index) {
          var findWithId = selected_ids[year][group][index];
          var semester = -1;
          var sel_module = [];
          for(item = 0; item < optional_modules_per_year[year][group].length; ++item) {
            var currentItem = optional_modules_per_year[year][group].uni_modules[item];
            if(currentItem.id == findWithId) {
              semester = currentItem.semester;
              // Create an array which stores the module, year, group
              sel_module = [currentItem, year, group];
              break;
            }
          }
          if(semester == 0) selected_modules_any_semester.push(sel_module);
          else if(semester == 1) selected_modules_first_semester.push(sel_module);
          else if(semester == 2) selected_modules_second_semester.push(sel_module);
          else if(semester == 3) selected_modules_year_long.push(sel_module);
          else if(semester == -1) console.log("ERROR");
        }
      }

      // Create table with columns for Semester 1 and 2
      targetDiv = document.getElementById("div_year_" + (year+1));
      myTable = "<table id =\"results_table_" + year + "\" style=\"width: 100%\"><tr><th>Semester 1</th><th>Semester 2</th></tr>";
      s1 = 0; // keeping track of column positions
      s2 = 0;

      // Fill in year long modules first, these are in index 3 of required_modules_per_year.
      for(i = 0; i < required_modules_per_year[year][3].length; ++i) {
        myTable += "<tr><td colspan=2>" + create_module_card(required_modules_per_year[year][3][i], false, 0, 0, 0) + "</td></tr>";
        s1++;
        s2++;
      }
      for(i = 0; i < selected_modules_year_long.length; ++i) {
        myTable += "<tr><td colspan=2>" + create_module_card(selected_modules_year_long[i][0], true, selected_year_long[i][1], selected_year_long[i][2], selectedt_year_long[i][3]) + "</td></tr>";
        s1++;
        s2++;
      }
      for(i=s1; i<4; i++){
        myTable +="<tr><td>" + create_blank_cell(year+1) + "</td><td>" + create_blank_cell(year+1) + "</td></tr>";
      }
      myTable += "</table>";      
      targetDiv.innerHTML = myTable;

      // find the table we've just created
      myTableOnPage = document.getElementById('results_table_'+year);
      // fill required modules in 1st semester
      for(i=0; i<required_modules_per_year[year][1].length; i++){
        myTableOnPage.rows[++s1].cells[0].innerHTML = create_module_card(required_modules_per_year[year][1][i], false, 0, 0, 0);
      }
      for(i=0; i < selected_modules_first_semester.length; i++){
        myTableOnPage.rows[++s1].cells[0].innerHTML = create_module_card(selected_modules_first_semester[i][0], true, selected_modules_first_semester[i][1], selected_modules_first_semester[i][2], selected_modules_first_semester[i][3]);
      }
      // 2nd semester
      for(i=0; i<required_modules_per_year[year][2].length; i++){
        myTableOnPage.rows[++s2].cells[1].innerHTML = create_module_card(required_modules_per_year[year][2][i], false, 0, 0, 0);
      }
      for(i=0; i < selected_modules_second_semester.length; i++){
        myTableOnPage.rows[++s2].cells[1].innerHTML = create_module_card(selected_modules_second_semester[i][0], true, selected_modules_second_semester[i][1], selected_modules_second_semester[i][2], selected_modules_second_semester[i][3]);
      }

      // fill modules that can go to any semester
      for(i=0; i<required_modules_per_year[year][3].length; i++){
        if(s2<s1){
          myTableOnPage.rows[++s2].cells[1].innerHTML = create_module_card(required_modules_per_year[year][3][i], false, 0, 0, 0);
        }else{
          myTableOnPage.rows[++s1].cells[0].innerHTML = create_module_card(required_modules_per_year[year][3][i], false, 0, 0, 0);
        }
      }
      for(i=0; i < selected_modules_any_semester.length; i++){
        if(s2<s1){
          myTableOnPage.rows[s2+1].cells[1].innerHTML = create_module_card(selected_modules_second_semester[i][0], true, selected_modules_second_semester[i][1], selected_modules_second_semester[i][2], selected_modules_second_semester[i][3]);
          s2++;
        }else{
          myTableOnPage.rows[s1+1].cells[0].innerHTML = create_module_card(selected_modules_second_semester[i][0], true, selected_modules_second_semester[i][1], selected_modules_second_semester[i][2], selected_modules_second_semester[i][3]);
          s1++;
        }
      }


      // generate optional modules buttons
      modalTarget = document.getElementById("optionsModalBodyYear" + (year + 1));
      modalTarget.innerHTML = "";
      nav = "<div id=\"pathway-tabs\"><ul class=\"nav nav-tabs\">";
      for(i=0; i<optional_modules_per_year[year].length; i++){  
        out = "<li><a role=\"tab\" data-toggle=\"tab\" id = \"btn_opt_year_"+year+"_group_"+i+"\">" + optional_modules_per_year[year][i].name + "</a></li>";
          nav += out;
      }
      nav += "</ul></div><div class=\"tab-pane fade in active col-md-12\" id = \"div_opt_year_" + year + "\" style=\"padding-top: 20px\"></div>";
      modalTarget.innerHTML += nav;


      for(i=0; i<optional_modules_per_year[year].length; i++){
        (function(_year, _i){
          button = document.getElementById("btn_opt_year_" + _year + "_group_" + _i);
          button.addEventListener("click", function(){
            optional_button_pressed(_year, _i, true, "tags");
          });
        })(year, i);  
      }

    }
  }

  function optional_button_pressed(_year, _i, useTags, sortby){
    target = document.getElementById("div_opt_year_" + _year);
    target.innerHTML = "";
    target.innerHTML += "<div class=\"row\"><span style=\"margin-bottom: 20px; display:inline-block;\" class=\"sort-area\">" +
                  <% sorting_options = {"tags" => "Tag match", "coursework" => "Coursework weighting", "exam" => "Exam weighting", "pass" => "Pass rate"} %>
                  "Sort by: &nbsp;&nbsp;" +
                    " <select class=\"selectpicker\" id=\"sort_by\" style=\"display:inline-block !important;\" onchange=\"sort(" + _year + "," + _i + ")\">" +
                      <% sorting_options.each do |option| %>
                        "<option value=\"<%= option.first %>\"" +
                         " >" +
                        "<%= option.second %>" +
                        "</option>" +
                      <% end %>
                    "</select>" +
                  "</span></div>";
    // Sort the optional modules by their tags matched percentage
    var addedModules = [];
    for(i = 0; i < optional_modules_per_year[_year][_i].uni_modules.length; ++i) {
      uni_mod = optional_modules_per_year[_year][_i].uni_modules[i];
      var result = module_results.filter(function(mod) {
        if(mod[0].id == uni_mod.id){
          return mod;
        }
      });
      if(result.length > 0 && useTags) {
        var tagsmatched = result[0][1];
        moduleCard = "<div class =\"row\">" +
                              "<button type=\"button\" class=\"login-card res-card result-card-" + colour_code_card_group(tagsmatched, <%= raw @chosen_tags %>) +  " res-btn\" id =\"btn_opt_select_year_"+_year+"_group_"+_i+"_index_"+i+"\" style=\"text-align: left\" data-toggle=\"tooltip\" data-placement=\"right\" data-original-title=\"Tags Matched: " + tagsmatched.join(", ") + "\"";
                                  if(selected_ids[_year][_i].indexOf(uni_mod.id) > -1) {
                                    moduleCard += " disabled ";
                                    console.log("fond");
                                  }
                                  console.log(uni_mod.id);
                                moduleCard += ">" +
                                "<div class=\"col-md-8\" style\"width: 75%\">" +
                                  "<p>" +  uni_mod.code + "</p>" +
                                  "<p>" + uni_mod.name + "</p>" +

                                "</div>" +
                                "<div class=\"col-md-1\" style=\"font-size: 18px; float: right\">" +
                                  "<a href=\"/uni_modules/" + uni_mod.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>";
                                  if(selected_ids[_year][_i].indexOf(uni_mod.id) > -1) {
                                    moduleCard += "<a class=\"deselect\" onclick = \"deselectModule(" + _year + ", " + _i + ", " + i + ")\"><i class=\"fa fa-trash\" aria-hidden=\"true\"></i></a>";
                                  }
                                moduleCard += "</div>" +
                                "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px; padding-left: 0px\">" +
                                  "<h4>" + Math.round((tagsmatched.length / <%= raw @chosen_tags %>.length) * 100) + " %</h4>" +        
                                "</div>"
                              "</button>" +
                            "</div>";
        target.innerHTML += moduleCard;
        addedModules.push(uni_mod);
      }
    }
    for(i = 0; i < optional_modules_per_year[_year][_i].uni_modules.length; ++i) {
      uni_mod = optional_modules_per_year[_year][_i].uni_modules[i];
       var foundAlready = addedModules.filter(function(mod) {
        if(mod.id == uni_mod.id){
          return mod;
        }
      });
      var result = [];
      var hasTags = [];
      if(foundAlready.length == 0) {
        console.log("Got here 1");
        if(!useTags) {
          var hasTags = module_results.filter(function(mod) {
            if(mod[0].id == uni_mod.id) {
              return mod;
            }
          });
        }
        if(hasTags.length > 0) {
          console.log("GOt here");
          var tagsmatched = hasTags[0][1];
          moduleCard = "<div class =\"row\">" +
                              "<button type=\"button\" class=\"login-card res-card result-card-" + colour_code_card_group(tagsmatched, <%= raw @chosen_tags %>) +  " res-btn\" id =\"btn_opt_select_year_"+_year+"_group_"+_i+"_index_"+i+"\" style=\"text-align: left\" data-toggle=\"tooltip\" data-placement=\"right\" data-original-title=\"Tags Matched: " + tagsmatched.join(", ") + "\"";
                                  if(selected_ids[_year][_i].indexOf(uni_mod.id) > -1) {
                                    moduleCard += " disabled ";
                                  }
                                moduleCard += ">" +
                                "<div class=\"col-md-8\" style\"width: 75%\">" +
                                  "<p>" +  uni_mod.code + "</p>" +
                                  "<p>" + uni_mod.name + "</p>" +

                                "</div>" +
                                "<div class=\"col-md-1\" style=\"font-size: 18px; float: right\">" +
                                  "<a href=\"/uni_modules/" + uni_mod.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>";
                                  if(selected_ids[_year][_i].indexOf(uni_mod.id) > -1) {
                                    moduleCard += "<a class=\"deselect\" onclick = \"deselectModule(" + _year + ", " + _i + ", " + i + ")\"><i class=\"fa fa-trash\" aria-hidden=\"true\"></i></a>";
                                  }
                                moduleCard += "</div>" +
                                "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px; padding-left: 0px\">" +
                                  "<h4>" + Math.round((tagsmatched.length / <%= raw @chosen_tags %>.length) * 100) + " %</h4>" +        
                                "</div>"
                              "</button>" +
                            "</div>"; 
        } else {
          moduleCard = "<div class =\"row\">" +
                              "<button type=\"button\" class=\"login-card res-card result-card-orange res-btn\" id =\"btn_opt_select_year_"+_year+"_group_"+_i+"_index_"+i+"\" style=\"text-align: left\" data-toggle=\"tooltip\" data-placement=\"right\" data-original-title=\"No tags matched.\"";
                                if(selected_ids[_year][_i].indexOf(uni_mod.id) > -1) {
                                    moduleCard += " disabled ";
                                  }
                                moduleCard += ">" +
                                "<div class=\"col-md-8\" style\"width: 75%\">" +
                                  "<p>" +  uni_mod.code + "</p>" +
                                  "<p>" + uni_mod.name + "</p>" +
                                "</div>" +
                                "<div class=\"col-md-1\" style=\"font-size: 18px; float: right\">" +
                                  "<a href=\"/uni_modules/" + uni_mod.id + "\"><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></a>";
                                  if(selected_ids[_year][_i].indexOf(uni_mod.id) > -1) {
                                    moduleCard += "<a class=\"deselect\" onclick = \"deselectModule(" + _year + ", " + _i + ", " + i + ")\"><i class=\"fa fa-trash\" aria-hidden=\"true\"></i></a>";
                                  } 
                                 moduleCard += "</div>" +
                                "<div class=\"col-md-3 tag-match-figure\" style=\"font-size:18px; padding-left: 0px\">" +
                                  "<h4> 0% </h4>" +
                                "</div>"
                              "</button>" +
                            "</div>";
        }
        target.innerHTML += moduleCard;
      }
    }

    var selecter = document.getElementById("sort_by");
    selecter.value = sortby;

    for(i=0; i<optional_modules_per_year[_year][_i].uni_modules.length; i++){
      if(!selected_modules_per_year[_year][_i][i]){
        (function(_year_, _i_, i_){
          button = document.getElementById("btn_opt_select_year_" + _year_ + "_group_" + _i_+"_index_"+i_);
          button.addEventListener("click", function(){
            console.log("hit");
            $("#optionsModalYear" + (_year + 1)).modal('hide');
            selectModule(_year_,_i_,i_);
          });
        })(_year, _i, i);
      }
    }
  }

  function selectModule(year, group, module_id){
    logStatus();
    console.log("########################################");
    console.log("########### selecting module ###########");
    this_module = null;
    for(i = 0; i < optional_modules_per_year[year][group].length; ++i) {
      var currentMod = optional_modules_per_year[year][group].uni_modules[i];
      if(currentMod.id == module_id) {
        this_module = currentMod;
        break;
      }
    }

    // Check that the module selected is able to be chosen

    // 1. Make sure we don't go over max modules or credits per group
    max_credits = optional_modules_per_year[year][group].max_credits;
    min_credits = optional_modules_per_year[year][group].min_credits;
    console.log("max credits in this group: " + max_credits);
    console.log("min credits in this group: " + min_credits);
    credits_used = 0;
    modules_selected_from_group = selected_ids[year][group].length;
    for(i = 0; i < selected_ids[year][group].length; ++i) {
        credits_used += selected_ids[year][group].uni_modules[i].credits;
      }
    }
    console.log("credits already used: " + credits_used);
    console.log("credits already selected: " + modules_selected_from_group);
    console.log("----------------------------------------");

    // 2. Don't select more than the max number of credits worth modules per year
    credits_this_year = 0;
    // Add credits from required modules
    for(group = 0; group < required_modules_per_year[year].length; ++group) {
      for(item = 0; item < required_modules_per_year[year][group].length; ++item) {
        credits_this_year += required_modules_per_year[year][group][item].credits;
          console.log(required_modules_per_year[year][group][item].name + 
            " (" + required_modules_per_year[year][group][item].credits + ")");
      }
    }
    // Add credits from selected modules
    for(group = 0; group < selected_ids[year].length; ++group){
      for(item = 0; item < selected_ids[year][group].length; i++){
        console.log("checking selected [y=" + year + ", group=" + group + ", item=" + item + "]");
          var findWithId = selected_ids[year][group][item];
          for(i = 0; i < optional_modules_per_year[year][group].length; ++i) {
            var currentMod = optional_modules_per_year[year][group].uni_modules[i];
            if(currentMod.id == findWithId) {
              credits_this_year += currentMod.credits;
              break;
            }
          }
        }
      }
    }

    // 3. Check this module has its requirements satisified
    requirementsSatisfied = true;
    if(this_module.uni_module_requirements.length > 0) {
      for(module = 0; module < this_module.uni_module_requirements.length; module++) {
        requiredMod = this_module.uni_module_requirements[module];
        moduleTaken = false;
        // Check if this required module is already in the compulsory modules (for all years)
        moduleSearch1:
        for(year = 0; year < js_course.year_structures.length; year++) {
          for(group = 0; group < required_modules_per_year[year].length; ++group) {
            for(item = 0; item < required_modules_per_year[year][group]; ++item) {
              currentMod = required_modules_per_year[year][group].uni_modules[item];
              if(requiredMod.id == currentMod.id) {
                moduleTaken = true;
                break moduleSearch1;
              }
            }
          }
        }
        if(moduleTaken) {
          continue; // If we have found the module at this point go to the next required module
        } else {
          // Check if this required module is in the selected modules (for all years)
          moduleSearch2:
          for(year = 0; year < js_course.year_structures.length; year++) {
            for(group = 0; group < optional_modules_per_year[year].length.length) {
              for(item = 0; item < selected_ids[year][group].length]) {
                if(requiredMod.id == selected_ids[year][group][item].id) {
                  moduleTaken = true;
                  break moduleSearch2;
                }
              }
            }
          }
          if(!moduleTaken) { // Module has not been found to be taken at this point
            requirementsSatisfied = false;
            break;
          }
        }
      }
    }


    console.log("credits used this year: " + credits_this_year);      
    console.log("----------------------------------------");
    if(credits_used >= max_credits) {
      window.alert("You have already selected enought credits from this group");
    }
    // !!UNSURE IF THIS SHOULD BE STATIC!!
    else if(credits_this_year+this_module.credits > 120) {
      window.alert("You have enough credits this year");
    }
    else if(!requirementsSatisfied) {
      window.alert("This module has prerequisites which you have not met");
    } else {
      selected_ids[year][group].push(this_module.id);
      updateUI();
    }
    
    //Tell the user they can now save again
    <% if logged_in? %>
    document.getElementById("save").innerHTML= "<span><i class=\"fa fa-star-o\" aria-hidden=\"true\"></i>&nbsp;&nbsp;Save Pathway</span>";
    <% end %>
  }

  function deselectModule(year, group, module){
    // TODO: validate
    selected_modules_per_year[year][group][module] = false;
    var id = selected_modules_per_year[year][group].uni_modules[module].id;
    var index = selected_ids[year][group].indexOf(id);
    if(index > -1) {
      selected_ids.splice(index, 1);
    }
    updateUI();
  }

  function updateData(){
    // Go through each year structure
    for(year = 0; year < js_course.year_structures.length; ++year) {
      requiredGroupModules = [];
      // Find the required groups for this year structure
      for(group= 0; group < js_course.year_structures[year].groups.length; ++group) {
        // If a group is marked as compulsory add its module to the required group modules array.
        currentGroup = js_course.year_structures[year].groups[group];
        if(currentGroup.compulsory) {
          requiredGroupModules = requiredGroupModules.concat(currentGroup.uni_modules);
        }
      }
      // Sort required modules for this year based on their semester
      modules_year_long = [];
      modules_first_semester = [];
      modules_second_semester = [];
      modules_any_semester = [];
      required_modules_this_year = [];
      for(module = 0; module < requiredGroupModules.length; ++module){
        if (requiredGroupModules[module].semester == 3) modules_year_long.push(requiredGroupModules[module]);
        else if(requiredGroupModules[module].semester == 2) modules_second_semester.push(requiredGroupModules[module]);
        else if(requiredGroupModules[module].semester == 1) modules_first_semester.push(requiredGroupModules[module]);
        else modules_any_semester.push(requiredGroupModules[module]);
      }
      // Add the sorted array into array.
      required_modules_this_year.push(modules_any_semester); // Index 0: Any Semester
      required_modules_this_year.push(modules_first_semester); // Index 1: First Semester
      required_modules_this_year.push(modules_second_semester); // Index 2: Second Semester
      required_modules_this_year.push(modules_year_long); // Index 3: Both Semesters

      optional_modules_this_year = [];
      // Find the optional modules for this year structure
      for(group = 1; group < js_course.year_structures[year].groups.length; ++group) {
        optional_modules_this_year.push(js_course.year_structures[year].groups[group]);
      }

      // Add the data for this year into the array for all years
      optional_modules_per_year.push(optional_modules_this_year);
      required_modules_per_year.push(required_modules_this_year);
    }

    if(<%=@year_of_study %> > divs.length) {
      document.getElementById('btn_all_years').click();
    } else {
      document.getElementById('btn_year_<%=@year_of_study%>').click();
    }
  }
</script>