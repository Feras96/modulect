<h1><%= @course.name %><br/></h1>
<% year = 2 %>
<% group = 1 %>
<div id = "log"></div>
<div align="center" style="margin-top: 10px">
	<%  @course.year_structures.each do |y| %> 
		<button id=<%= "btn_year_#{y.read_attribute_before_type_cast('year_of_study')}" %>  type="button">
			<%= y.year_of_study %>
		</button>
	<%  end %>
	<button id="btn_all_years"  type="button">show all</button>

	<%  @course.year_structures.each do |y| %> 
		<div id=<%= "div_year_#{y.read_attribute_before_type_cast('year_of_study')}" %>>
			Required modules<br/>
			<% y.groups.each do |grp| %>
				<% if grp.name == "required" %>
					<% grp.uni_modules.each do |y_req_module| %>
						<%= " - #{y_req_module[:name]} (#{y_req_module[:credits]} credits)" %> <br/>
					<% end %>
				<% end %>
			<% end %>
			<% y.groups.each do |grp| %>
				<% if grp.name == "optional" %>
					<br/>
					<%= "Select #{grp.total_credits} credits from #{grp.uni_modules.size} modules" %>
					<br/>
					<% grp.uni_modules.each do |y_opt_module| %>
						<%= " - #{y_opt_module[:name]} (#{y_opt_module[:credits]} credits)" %> <br/>
					<% end %>
				<% end %>
			<% end %>
		</div>
	<%  end %>

</div>


<script type="text/javascript">
	// get JSON object from rails
	var data = '<%=raw @course.to_json(
		include:
			{year_structures:
				{include:
					{groups:
						{:include => :uni_modules}}}}).sub("'", "\\\\'") %>';
	var js_course = jQuery.parseJSON(data);

	// globals to keep track of selected modules
	var selected_modules_per_year = [];
	var required_modules_per_year = [];
	var optional_modules_per_year = [];

	// selected modules this year is all set to false
	updateData();
	selectModule(0,0,1);
	selectModule(2,2,1);
	selectModule(2,2,15);
	selectModule(2,2,3);
	udpateUI();

	// debugging
	logStatus();
	function logStatus(){
		console.log("JSON course object");
		console.log(js_course);
		console.log("Required modules per year");
		console.log(required_modules_per_year);
		console.log("Optional modules per year");
		console.log(optional_modules_per_year);
		console.log("Selected modules per year");
		console.log(selected_modules_per_year);
	}




	function udpateUI(){
		for(year=0; year<js_course.year_structures.length; year++){
			// get all optional modules
			selected_modules_buttons_any_semester = [];
			selected_modules_buttons_first_semester = [];
			selected_modules_buttons_second_semester = [];
			selected_modules_buttons_year_long = [];
			for(g=0; g<optional_modules_per_year[year].length; g++){
				for(index=0; index<selected_modules_per_year[year][g].length; index++){
					if(selected_modules_per_year[year][g][index]){
						name = optional_modules_per_year[year][g].uni_modules[index].name;
						credits = optional_modules_per_year[year][g].uni_modules[index].credits;
						semester = optional_modules_per_year[year][g].uni_modules[index].semester;
						
						console.log("Moudle selected from group " + g + " in year " + year + ": " + name + " (" + credits + " credits, semester " + semester + ")");
						button = "<button onclick = \"deselectModule(" + year + ", " + g + ", " + index + ")\">"+name+"</button>";
						if(semester == 0) selected_modules_buttons_any_semester.push(button);
						if(semester == 1) selected_modules_buttons_first_semester.push(button);
						if(semester == 2) selected_modules_buttons_second_semester.push(button);
						if(semester == 3) selected_modules_buttons_year_long.push(button);
					}
				}
			}


			targetDiv = document.getElementById("div_year_" + (year+1)); 
			myTable = "<table id =\"results_table_" + year + "\"><tr><th>Semester 1</th><th>Semester 2</th></tr>";
			s1 = 0; // keeping track of column positions
			s2 = 0;

			// create the table and fill in year long modules first
			for(i=0; i<required_modules_per_year[year][0].length; i++){
				myTable += "<tr><td colspan=2>" + required_modules_per_year[year][0][i].name + "</td></tr>";
				s1++;
				s2++;
			}
			for(i=0; i<selected_modules_buttons_year_long.length; i++){
				myTable += "<tr><td colspan=2>" + selected_modules_buttons_year_long + "</td></tr>";
				s1++;
				s2++;
			}
			for(i=s1; i<4; i++){
				myTable +="<tr><td>?</td><td>?</td></tr>";
			}
			myTable += "</table><div id=\"optional_buttons_year_"+year+"\"></div><div>";			
			targetDiv.innerHTML = myTable;

			// find the table we've just created
			myTableOnPage = document.getElementById('results_table_'+year);
			// fill required modules in 1st semester
			for(i=0; i<required_modules_per_year[year][1].length; i++){
				myTableOnPage.rows[++s1].cells[0].innerHTML = required_modules_per_year[year][1][i].name;
			}
			for(i=0; i < selected_modules_buttons_first_semester.length; i++){
				myTableOnPage.rows[++s1].cells[0].innerHTML = selected_modules_buttons_first_semester[i];
			}
			// 2nd semester
			for(i=0; i<required_modules_per_year[year][2].length; i++){
				myTableOnPage.rows[++s2].cells[1].innerHTML = required_modules_per_year[year][2][i].name;
			}
			for(i=0; i < selected_modules_buttons_second_semester.length; i++){
				myTableOnPage.rows[++s2].cells[1].innerHTML = selected_modules_buttons_second_semester[i];
			}

			// fill modules that can go to any semester
			for(i=0; i<required_modules_per_year[year][3].length; i++){
				if(s2<s1){
					myTableOnPage.rows[++s2].cells[1].innerHTML = required_modules_per_year[year][3][i].name;
				}else{
					myTableOnPage.rows[++s1].cells[0].innerHTML = required_modules_per_year[year][3][i].name;
				}
			}
			for(i=0; i < selected_modules_buttons_any_semester.length; i++){
				if(s2<s1){
					myTableOnPage.rows[s2+1].cells[1].innerHTML = selected_modules_buttons_second_semester[i];
					s2++;
				}else{
					myTableOnPage.rows[s1+1].cells[0].innerHTML = selected_modules_buttons_second_semester[i];
					s1++;
				}
			}


			// generate optional modules buttons
			opt_buttons_div = document.getElementById("optional_buttons_year_"+year);
			for(i=0; i<optional_modules_per_year[year].length; i++){	
				out = "<button id = \"btn_opt_year_"+year+"_group_"+i+"\">Get " + 
					optional_modules_per_year[year][i].total_credits + 
					" credits";
					opt_buttons_div.innerHTML += out;
			}
			opt_buttons_div.innerHTML += "<div id = \"div_opt_year_" + year + "\"></div>";


			for(i=0; i<optional_modules_per_year[year].length; i++){
				(function(_year, _i){
					button = document.getElementById("btn_opt_year_" + _year + "_group_" + _i);
					button.addEventListener("click", function(){
						optional_button_pressed(_year, _i);
					});
				})(year, i);	
			}

		}
	}

	function optional_button_pressed(_year, _i){
		target = document.getElementById("div_opt_year_" + _year);
		target.innerHTML = "";
		for(i=0; i<optional_modules_per_year[_year][_i].uni_modules.length; i++){
			target.innerHTML += "<button id =\"btn_opt_select_year_"+_year+"_group_"+_i+"_index_"+i+"\">" + 
			optional_modules_per_year[_year][_i].uni_modules[i].name + "</button><br/>";
		}

		for(i=0; i<optional_modules_per_year[_year][_i].uni_modules.length; i++){
			(function(_year_, _i_, i_){
				button = document.getElementById("btn_opt_select_year_" + _year_ + "_group_" + _i_+"_index_"+i_);
				button.addEventListener("click", function(){
					selectModule(_year_,_i_,i_);
				});
			})(_year, _i, i);
		}
	}

	function selectModule(year, group, module){
		// TODO: validate
		selected_modules_per_year[year][group][module] = true;
		udpateUI();
		logStatus();
	}

	function deselectModule(year, group, module){
		// TODO: validate
		selected_modules_per_year[year][group][module] = false;
		udpateUI();
		logStatus();
	}

	function updateData(){
		// go through each year
		for(year=0; year<js_course.year_structures.length; year++){

			// sort required modules for this year
			required_group = js_course.year_structures[year].groups[0].uni_modules;
			modules_year_long = [];
			modules_fisrt_semester = [];
			modules_second_semester = [];
			modules_any_semester = [];
			required_modules_this_year = [];
			for(module=0; module<required_group.length; module++){
				if     (required_group[module].semester == 3) modules_year_long.push(required_group[module]);
				else if(required_group[module].semester == 2) modules_second_semester.push(required_group[module]);
				else if(required_group[module].semester == 1) modules_fisrt_semester.push(required_group[module]);
				else 									      modules_any_semester.push(required_group[module]);
			}
			required_modules_this_year.push(modules_any_semester);
			required_modules_this_year.push(modules_fisrt_semester);
			required_modules_this_year.push(modules_second_semester);
			required_modules_this_year.push(modules_year_long);

			optional_modules_this_year = [];
			for(grp=1; grp<js_course.year_structures[year].groups.length; grp++){
				optional_modules_this_year.push(js_course.year_structures[year].groups[grp]);
			}

			selected_modules_this_year = [];
			for(grp=1; grp<js_course.year_structures[year].groups.length; grp++){
				selected_modules_in_this_group = [];
				for(mod=0; mod<js_course.year_structures[year].groups[grp].uni_modules.length; mod++){
					selected_modules_in_this_group.push(false);
				}
				selected_modules_this_year.push(selected_modules_in_this_group);
			}

			optional_modules_per_year.push(optional_modules_this_year);
			required_modules_per_year.push(required_modules_this_year);
			selected_modules_per_year.push(selected_modules_this_year);
		}
	}
</script>